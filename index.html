<!doctype html>
<html lang="pt">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Planetas AR</title>
  <script type="module" src="https://unpkg.com/@google/model-viewer/dist/model-viewer.min.js"></script>
  <style>body{margin:0;font-family:system-ui;background:#0b0b0c;color:#fff}model-viewer{width:100%;height:100vh}</style>
</head>
<body>
  <model-viewer id="viewer"
    ar ar-modes="webxr scene-viewer quick-look"
    camera-controls interaction-prompt="auto"
    auto-rotate auto-rotate-delay="0"
    style="--poster-color: transparent;">
  </model-viewer>
  <script type="module">
    const params = new URLSearchParams(location.search);
    const key = (params.get("planet") || "marte").toLowerCase();
    const viewer = document.getElementById("viewer");
    async function init(){
      const res = await fetch("/planets.json"); const data = await res.json();
      const cfg = data[key] || data["marte"];
      viewer.src = cfg.glb;
      viewer.setAttribute("ios-src", cfg.usdz);
      const s = cfg.scale || 1.2;
      viewer.setAttribute("scale", `${s} ${s} ${s}`);
    }
    init();

    // Animated moons when running WebXR in-page (JS)
    async function animateMoons() {
      await viewer.updateComplete;
      const model = viewer.model;
      if (!model || !model.getNodeByName || !model.setNodeTransform) return;
      const phobos = model.getNodeByName('Phobos');
      const deimos = model.getNodeByName('Deimos');
      if (!phobos || !deimos) return;
      const t0 = performance.now();
      function loop(){
        const t = (performance.now()-t0)/1000;
        const aP = (t/12.0)*Math.PI*2.0;
        const aD = (t/20.0)*Math.PI*2.0;
        const rP=2.0, rD=3.2;
        const mPh=[Math.cos(aP),0,Math.sin(aP),0, 0,1,0,0, -Math.sin(aP),0,Math.cos(aP),0, rP*Math.cos(aP),0,rP*Math.sin(aP),1];
        const mDe=[Math.cos(aD),0,Math.sin(aD),0, 0,1,0,0, -Math.sin(aD),0,Math.cos(aD),0, rD*Math.cos(aD),0,rD*Math.sin(aD),1];
        model.setNodeTransform(phobos,mPh);
        model.setNodeTransform(deimos,mDe);
        requestAnimationFrame(loop);
      }
      loop();
    }
    viewer.addEventListener('load',()=>{ if(key==='marte') animateMoons(); });
  </script>
</body>
</html>
