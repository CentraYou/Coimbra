<!doctype html>
<html lang="pt">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Planetas AR</title>
  <meta name="description" content="Explora planetas e um livro em Realidade Aumentada." />
  <link rel="stylesheet" href="/styles.css" />
  <script type="module" src="https://unpkg.com/@google/model-viewer/dist/model-viewer.min.js"></script>
</head>
<body>
  <header>
    <img id="mall-logo" alt="Logo do shopping"
         src="https://www.forum-coimbra.com/wp-content/uploads/sites/23/2024/09/header-logo-1-1.png"
         onerror="this.src='/assets/logo.png'"
         style="height:28px;object-fit:contain" />
    <div class="badge" id="planet-badge">AR</div>
    <div class="note">Toque para colocar no espaço</div>
  </header>

  <model-viewer id="viewer"
    ar ar-modes="webxr scene-viewer quick-look"
    camera-controls interaction-prompt="auto"
    auto-rotate auto-rotate-delay="0"
    shadow-intensity="0" exposure="1"
    environment-image="neutral"
    style="--poster-color: transparent;">
  </model-viewer>

  <section id="info">
    <h1 id="planet-title">Experiência AR</h1>
    <ul id="bullets"></ul>
    <ul class="inline">
      <li><strong>Dica:</strong> dois dedos para redimensionar.</li>
      <li><strong>Segurança:</strong> atenção ao redor ao usar AR.</li>
    </ul>
  </section>

  <div class="bar">
    <button class="primary" id="btn-ar">Ativar AR</button>
    <button id="btn-center">Recentra</button>
    <button id="btn-snapshot">Foto</button>
  </div>

  <script type="module">
    const params = new URLSearchParams(location.search);
    const key = (params.get("planet") || "marte").toLowerCase();
    const viewer = document.getElementById("viewer");
    const title = document.getElementById("planet-title");
    const badge = document.getElementById("planet-badge");
    const bullets = document.getElementById("bullets");

    async function init() {
      let dataMap = {};
      try {
        const res = await fetch("/planets.json");
        dataMap = await res.json();
      } catch(e) { console.warn("Não foi possível carregar planets.json", e); }

      const data = dataMap[key] || dataMap["marte"] || {};
      title.textContent = data.name || "Experiência AR";
      badge.textContent = data.name || "AR";

      // Fonte do modelo
      if (data.glb) viewer.src = data.glb;
      if (data.usdz) viewer.setAttribute("ios-src", data.usdz);

      // Escala
      const s = data.scale || 1.2;
      viewer.setAttribute("scale", `${s} ${s} ${s}`);

      // Bullets
      bullets.innerHTML = (data.bullets || []).map(b => `<li>${b}</li>`).join("");

      // AR placement dinâmico: livro em parede; restantes no chão
      viewer.setAttribute("ar-placement", key === "livro" ? "wall" : "floor");

      // Botões
      document.getElementById("btn-ar").onclick = () => viewer.activateAR();
      document.getElementById("btn-center").onclick = () => viewer.resetTurntableRotation();
      document.getElementById("btn-snapshot").onclick = async () => {
        try {
          const canvas = viewer.renderedScene || viewer.shadowRoot?.querySelector("canvas");
          if (!canvas) return alert("Não disponível neste dispositivo.");
          const snapshot = canvas.toDataURL("image/png");
          const a = document.createElement("a");
          a.href = snapshot; a.download = `${key}_ar.png`; a.click();
        } catch (e) { alert("Não foi possível gerar a imagem neste dispositivo."); }
      };

      // Órbita das luas (apenas se renderizar in-page; em Scene Viewer/Quick Look a animação deve vir do asset GLB/USDZ)
      async function animateMoons() {
        await viewer.updateComplete;
        const model = viewer.model;
        if (!model || !model.getNodeByName || !model.setNodeTransform) return;
        const phobos = model.getNodeByName('Phobos');
        const deimos = model.getNodeByName('Deimos');
        if (!phobos || !deimos) return;
        const t0 = performance.now();
        function loop(){
          const t = (performance.now()-t0)/1000;
          const aP = (t/12.0)*Math.PI*2.0;
          const aD = (t/20.0)*Math.PI*2.0;
          const rP=2.0, rD=3.2;
          const mPh=[Math.cos(aP),0,Math.sin(aP),0, 0,1,0,0, -Math.sin(aP),0,Math.cos(aP),0, rP*Math.cos(aP),0,rP*Math.sin(aP),1];
          const mDe=[Math.cos(aD),0,Math.sin(aD),0, 0,1,0,0, -Math.sin(aD),0,Math.cos(aD),0, rD*Math.cos(aD),0,rD*Math.sin(aD),1];
          model.setNodeTransform(phobos,mPh);
          model.setNodeTransform(deimos,mDe);
          requestAnimationFrame(loop);
        }
        loop();
      }
      if (key==='marte') viewer.addEventListener('load', animateMoons);
    }
    init();
  </script>

  <footer>
    © 2025 Planetas AR — WebXR / Scene Viewer / Quick Look.
  </footer>
</body>
</html>
