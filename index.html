<!doctype html>
<html lang="pt">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Planetas AR</title>
  <link rel="stylesheet" href="./styles.css" />
  <script type="module" src="https://unpkg.com/@google/model-viewer/dist/model-viewer.min.js"></script>
</head>
<body>
  <header>
    <img src="https://www.forum-coimbra.com/wp-content/uploads/sites/23/2024/09/header-logo-1-1.png" alt="Logo" style="height:24px;object-fit:contain" />
    <div class="note">Aponte ao chão e toque para colocar</div>
  </header>

  <model-viewer id="viewer"
    ar ar-modes="webxr scene-viewer quick-look"
    camera-controls interaction-prompt="auto"
    auto-rotate auto-rotate-delay="0"
    environment-image="neutral"
    exposure="1.5"
    skybox-image="./assets/stars.jpg"
    style="--poster-color: transparent;">
  </model-viewer>

  <section id="info">
    <h1 id="planet-title">Planeta</h1>
    <ul id="bullets"></ul>
  </section>

  <div class="toolbar">
    <button id="btn-ar">Ativar AR</button>
    <button id="btn-center">Recentra</button>
  </div>
  <button id="bg-toggle">Fundo: Estrelas</button>

  <script type="module">
    const params = new URLSearchParams(location.search);
    const key = (params.get('planet') || 'marte').toLowerCase();
    const viewer = document.getElementById('viewer');
    const title = document.getElementById('planet-title');
    const bullets = document.getElementById('bullets');

    async function fileExists(path){
      try{
        const r = await fetch(path, {method:'HEAD'});
        return r.ok;
      }catch{ return false; }
    }

    async function init(){
      const res = await fetch('./planets.json'); const data = await res.json();
      const cfg = data[key] || data['marte'];
      title.textContent = cfg.name || 'Planeta';
      bullets.innerHTML = (cfg.bullets||[]).map(b=>`<li>${b}</li>`).join('');

      // Prefer animated assets; if not found, fallback to textured
      const glbAnim = cfg.glb.startsWith('/')? cfg.glb : ('./'+cfg.glb.replace(/^\/?/,''));
      const usdzAnim = cfg.usdz.startsWith('/')? cfg.usdz : ('./'+cfg.usdz.replace(/^\/?/,''));
      const glbFallback = './models/mars_system_textured.glb';

      if (await fileExists(glbAnim)) viewer.src = glbAnim; else viewer.src = glbFallback;
      viewer.setAttribute('ios-src', await fileExists(usdzAnim) ? usdzAnim : '');

      const s = cfg.scale || 1.4; viewer.setAttribute('scale', `${s} ${s} ${s}`);
      document.getElementById('btn-ar').onclick = ()=> viewer.activateAR();
      document.getElementById('btn-center').onclick = ()=> viewer.resetTurntableRotation();
    }

    // Background toggle (stars ↔ black ↔ stars+bright)
    (function(){
      let mode=0;
      const btn = document.getElementById('bg-toggle');
      function apply(){
        if(mode===0){ viewer.setAttribute('skybox-image','./assets/stars.jpg'); viewer.setAttribute('environment-image','neutral'); viewer.setAttribute('exposure','1.5'); btn.textContent='Fundo: Estrelas'; }
        else if(mode===1){ viewer.removeAttribute('skybox-image'); viewer.setAttribute('environment-image','neutral'); viewer.setAttribute('exposure','1.5'); btn.textContent='Fundo: Preto'; }
        else { viewer.setAttribute('skybox-image','./assets/stars.jpg'); viewer.setAttribute('environment-image','./assets/stars.jpg'); viewer.setAttribute('exposure','1.8'); btn.textContent='Fundo: Estrelas (Brilho)'; }
      }
      btn.addEventListener('click',()=>{ mode=(mode+1)%3; apply(); });
      apply();
    })();

    init();
  </script>
</body>
</html>
